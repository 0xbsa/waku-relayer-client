{"version":3,"file":"relayer-connection-status.js","sourceRoot":"","sources":["../../src/status/relayer-connection-status.ts"],"names":[],"mappings":";;;AAAA,oEAI0C;AAC1C,iEAA4D;AAC5D,8DAA0D;AAC1D,wDAAyD;AACzD,2EAAqE;AACrE,oDAAgD;AAEhD,MAAa,aAAa;IACxB,MAAM,CAAC,0BAA0B,CAAC,KAAY;QAC5C,IAAI,4CAAmB,CAAC,QAAQ,EAAE;YAChC,OAAO,uCAAuB,CAAC,KAAK,CAAC;SACtC;QACD,IAAI,CAAC,4CAAmB,CAAC,IAAI,EAAE;YAC7B,OAAO,uCAAuB,CAAC,YAAY,CAAC;SAC7C;QACD,IAAI,CAAC,IAAI,CAAC,wBAAwB,CAAC,KAAK,CAAC,EAAE;YACzC,OAAO,uCAAuB,CAAC,SAAS,CAAC;SAC1C;QAED,MAAM,EAAE,qBAAqB,EAAE,oBAAoB,EAAE,GACnD,IAAI,CAAC,4BAA4B,CAAC,KAAK,CAAC,CAAC;QAC3C,IAAI,qBAAqB,EAAE;YACzB,OAAO,uCAAuB,CAAC,YAAY,CAAC;SAC7C;QACD,IAAI,CAAC,oBAAoB,EAAE;YACzB,OAAO,uCAAuB,CAAC,cAAc,CAAC;SAC/C;QAED,OAAO,uCAAuB,CAAC,SAAS,CAAC;IAC3C,CAAC;IAEO,MAAM,CAAC,wBAAwB,CAAC,KAAY;QAClD,MAAM,WAAW,GAAG,mCAAe,CAAC,YAAY,CAAC,KAAK,CAAC,CAAC;QACxD,IAAI,CAAC,IAAA,sBAAS,EAAC,WAAW,CAAC,IAAI,CAAC,IAAA,sBAAS,EAAC,WAAW,CAAC,QAAQ,CAAC,EAAE;YAC/D,OAAO,KAAK,CAAC;SACd;QAED,MAAM,mBAAmB,GAAG,MAAM,CAAC,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;QAEhE,OAAO,CACL,mBAAmB,CAAC,IAAI,CAAC,eAAe,CAAC,EAAE;YACzC,MAAM,0BAA0B,GAAG,MAAM,CAAC,IAAI,CAC5C,eAAe,CAAC,UAAU,CAC3B,CAAC;YACF,MAAM,wBAAwB,GAAG,8BAAa,CAAC,MAAM,CACnD,0BAA0B,CAC3B,CAAC;YACF,OAAO,wBAAwB,CAAC,MAAM,GAAG,CAAC,CAAC;QAC7C,CAAC,CAAC,IAAI,IAAI,CACX,CAAC;IACJ,CAAC;IAEO,MAAM,CAAC,4BAA4B,CAAC,KAAY;QACtD,MAAM,WAAW,GAAG,mCAAe,CAAC,YAAY,CAAC,KAAK,CAAC,CAAC;QACxD,IAAI,CAAC,IAAA,sBAAS,EAAC,WAAW,CAAC,IAAI,CAAC,IAAA,sBAAS,EAAC,WAAW,CAAC,QAAQ,CAAC,EAAE;YAC/D,OAAO,EAAE,qBAAqB,EAAE,KAAK,EAAE,oBAAoB,EAAE,KAAK,EAAE,CAAC;SACtE;QAED,MAAM,mBAAmB,GAAG,MAAM,CAAC,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;QAEhE,IAAI,qBAAqB,GAAG,IAAI,CAAC;QACjC,IAAI,oBAAoB,GAAG,KAAK,CAAC;QAEjC,mBAAmB,CAAC,OAAO,CAAC,eAAe,CAAC,EAAE;YAC5C,MAAM,0BAA0B,GAAG,MAAM,CAAC,IAAI,CAC5C,eAAe,CAAC,UAAU,CAC3B,CAAC;YACF,MAAM,wBAAwB,GAAG,8BAAa,CAAC,MAAM,CACnD,0BAA0B,CAC3B,CAAC;YACF,wBAAwB,CAAC,OAAO,CAAC,cAAc,CAAC,EAAE;gBAChD,MAAM,WAAW,GAAa,MAAM,CAAC,IAAI,CACvC,eAAe,CAAC,UAAU,CAAC,cAAc,CAAC,CAAC,aAAa,CACzD,CAAC;gBAGF,WAAW,CAAC,KAAK,CAAC,UAAU,CAAC,EAAE;oBAC7B,MAAM,QAAQ,GACZ,eAAe,CAAC,UAAU,CAAC,cAAc,CAAC,CAAC,aAAa,CACtD,UAAU,CACX,CAAC;oBACJ,IAAI,IAAA,+BAAgB,EAAC,QAAQ,CAAC,UAAU,CAAC,EAAE;wBACzC,OAAO,IAAI,CAAC;qBACb;oBAGD,qBAAqB,GAAG,KAAK,CAAC;oBAE9B,IAAI,QAAQ,CAAC,gBAAgB,GAAG,CAAC,EAAE;wBACjC,oBAAoB,GAAG,IAAI,CAAC;wBAC5B,OAAO,KAAK,CAAC;qBACd;oBACD,OAAO,IAAI,CAAC;gBACd,CAAC,CAAC,CAAC;YACL,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,OAAO,EAAE,qBAAqB,EAAE,oBAAoB,EAAE,CAAC;IACzD,CAAC;CACF;AA5FD,sCA4FC","sourcesContent":["import {\n  CachedTokenFee,\n  Chain,\n  RelayerConnectionStatus,\n} from '@railgun-community/shared-models';\nimport { RelayerFeeCache } from '../fees/relayer-fee-cache';\nimport { AddressFilter } from '../filters/address-filter';\nimport { cachedFeeExpired } from '../utils/relayer-util';\nimport { WakuRelayerWakuCore } from '../waku/waku-relayer-waku-core';\nimport { isDefined } from '../utils/is-defined';\n\nexport class RelayerStatus {\n  static getRelayerConnectionStatus(chain: Chain): RelayerConnectionStatus {\n    if (WakuRelayerWakuCore.hasError) {\n      return RelayerConnectionStatus.Error;\n    }\n    if (!WakuRelayerWakuCore.waku) {\n      return RelayerConnectionStatus.Disconnected;\n    }\n    if (!this.hasRelayerFeesForNetwork(chain)) {\n      return RelayerConnectionStatus.Searching;\n    }\n\n    const { allRelayerFeesExpired, anyRelayersAvailable } =\n      this.getAggregatedInfoForRelayers(chain);\n    if (allRelayerFeesExpired) {\n      return RelayerConnectionStatus.Disconnected;\n    }\n    if (!anyRelayersAvailable) {\n      return RelayerConnectionStatus.AllUnavailable;\n    }\n\n    return RelayerConnectionStatus.Connected;\n  }\n\n  private static hasRelayerFeesForNetwork(chain: Chain) {\n    const relayerFees = RelayerFeeCache.feesForChain(chain);\n    if (!isDefined(relayerFees) || !isDefined(relayerFees.forToken)) {\n      return false;\n    }\n\n    const cachedTokenRelayers = Object.values(relayerFees.forToken);\n\n    return (\n      cachedTokenRelayers.find(tokenRelayerMap => {\n        const unfilteredRelayerAddresses = Object.keys(\n          tokenRelayerMap.forRelayer,\n        );\n        const filteredRelayerAddresses = AddressFilter.filter(\n          unfilteredRelayerAddresses,\n        );\n        return filteredRelayerAddresses.length > 0;\n      }) != null\n    );\n  }\n\n  private static getAggregatedInfoForRelayers(chain: Chain) {\n    const relayerFees = RelayerFeeCache.feesForChain(chain);\n    if (!isDefined(relayerFees) || !isDefined(relayerFees.forToken)) {\n      return { allRelayerFeesExpired: false, anyRelayersAvailable: false };\n    }\n\n    const cachedTokenRelayers = Object.values(relayerFees.forToken);\n\n    let allRelayerFeesExpired = true;\n    let anyRelayersAvailable = false;\n\n    cachedTokenRelayers.forEach(tokenRelayerMap => {\n      const unfilteredRailgunAddresses = Object.keys(\n        tokenRelayerMap.forRelayer,\n      );\n      const filteredRailgunAddresses = AddressFilter.filter(\n        unfilteredRailgunAddresses,\n      );\n      filteredRailgunAddresses.forEach(railgunAddress => {\n        const identifiers: string[] = Object.keys(\n          tokenRelayerMap.forRelayer[railgunAddress].forIdentifier,\n        );\n\n        // Loops until we hit `return false`.\n        identifiers.every(identifier => {\n          const tokenFee: CachedTokenFee =\n            tokenRelayerMap.forRelayer[railgunAddress].forIdentifier[\n              identifier\n            ];\n          if (cachedFeeExpired(tokenFee.expiration)) {\n            return true; // continue\n          }\n\n          // Any unexpired means we didn't time out.\n          allRelayerFeesExpired = false;\n\n          if (tokenFee.availableWallets > 0) {\n            anyRelayersAvailable = true;\n            return false; // break\n          }\n          return true; //continue\n        });\n      });\n    });\n\n    return { allRelayerFeesExpired, anyRelayersAvailable };\n  }\n}\n"]}